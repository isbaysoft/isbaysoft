<div class="btn-group">
  <a class="btn input-medium" href="#" id="screenshot-select-id"><i class="icon-folder-open"></i> <%= t(:label_select) %></a>
  <a class="btn input-medium" href="#" id="screenshot-upload-id"><i class="icon-upload"></i> <%= t(:label_upload) %></a>
</div>
<hr>

<ul class="thumbnails">
<% @document.screenshots.map do |img| %>
  <li class="span2">
    <div class="thumbnail">
      <%= link_to('Удалить', admin_document_screenshot_url(@document,img), :class => 'btn', :method => :delete) %>
      <%= image_tag img.screenshot.url %>
      <div class="caption">
        <h5><%= img.screenshot_file_name  %></h5>
        <p><%= number_to_human_size(img.screenshot_file_size) %></p>
      <end>
    </div>
  </li>
<% end if @document.screenshots.present? %>
</ul>

<script type="text/javascript">
  $(function() {
    authtoken = $("input[name=authenticity_token]").val();
    var uploader = new plupload.Uploader({
      runtimes : 'gears,html5,flash,silverlight',
      browse_button : 'screenshot-select-id',
      max_file_size : '10mb', // TODO: size from model
      url : '<%= uploadscreenshot_admin_document_url %>',
      flash_swf_url : '<%= javascript_path '/plupload/plupload.flash.swf' %>',
      silverlight_xap_url : '<%= javascript_path '/plupload/plupload.silverlight.xap' %>',
      filters : [{title : "Image files", extensions : "jpg,gif,png"}],
      multipart_params : {
        'format': 'json',
        authenticity_token: authtoken
      },
      file_data_name: 'document[screenshot]'
    });

    $('#screenshot-upload-id').click(function(e) {
      uploader.start();
      e.preventDefault();
    });

    uploader.init();

    uploader.bind('FilesAdded', function(up, files) {
      $.each(files, function(i, file) {
        $("#screenshot_add_template").tmpl(file).fadeIn().appendTo(".thumbnails");
      });
      up.refresh(); // Reposition Flash/Silverlight
    });

    uploader.bind('UploadProgress', function(up, file) {
      var size = plupload.formatSize(file.size)
      var loaded = plupload.formatSize(file.loaded)
      
      $('#pre_' + file.id).html("<div class='progress progress-info'><div class='bar' style='width: " + file.percent + "%;'></div></div>");
    });
    

    uploader.bind('Error', function(up, err) {
      up.refresh(); // Reposition Flash/Silverlight
    });

    uploader.bind('FileUploaded', function(up, file, info) {
      var response = JSON.parse(info['response']);
      var url = JSON.parse(response['url']);
      $('#document_logo').attr("src", url);
      $('#document_logo_id').attr('value', response['id']);

    });
  });
</script>


<%= javascript_include_tag 'jquery.template.min.js' %>

<script id="screenshot_add_template" type="text/x-jquery-tmpl">
 <li class="span2">
    <div class="thumbnail">
    <a href="#" id="file_id_${id}_rm" class="btn pull-right"><i class="icon-trash"></i></a>
      <pre id="pre_${id}">?</pre>
      <div class="caption">
        <h5>${name}</h5>
      </div>
  </li>
</script>